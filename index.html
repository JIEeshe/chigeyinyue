<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' https:; script-src 'self' 'unsafe-inline' https:; style-src 'self' 'unsafe-inline' https:;">
    <title>È©∞Âì•Èü≥‰πê‰∏ãËΩΩÂô®</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #000;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .titlebar {
            height: 50px;
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 2px solid #ff6b35;
            flex-shrink: 0;
            -webkit-app-region: drag;
            position: relative;
        }

        .menu-button {
            position: absolute;
            left: 10px;
            width: 40px;
            height: 40px;
            background: transparent;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
            transition: background-color 0.2s;
            -webkit-app-region: no-drag;
        }

        .menu-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .titlebar h1 {
            margin: 0;
            color: white;
            font-size: 18px;
            font-weight: 600;
            font-family: 'Arial', sans-serif;
            letter-spacing: 1px;
        }

        .window-controls {
            position: absolute;
            right: 0;
            top: 0;
            height: 100%;
            display: flex;
            -webkit-app-region: no-drag;
        }

        .window-controls button {
            width: 50px;
            height: 100%;
            border: none;
            background: transparent;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .window-controls button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .window-controls button.close:hover {
            background-color: #e81123;
        }

        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
        }

        .sidebar {
            width: 250px;
            background: linear-gradient(180deg, #2d2d2d 0%, #1a1a1a 100%);
            border-right: 2px solid #ff6b35;
            overflow-y: auto;
            flex-shrink: 0;
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 100;
        }

        .sidebar.active {
            transform: translateX(0);
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid rgba(255, 107, 53, 0.3);
        }

        .sidebar-header h2 {
            margin: 0;
            color: white;
            font-size: 16px;
            font-family: 'Arial', sans-serif;
        }

        .website-list {
            padding: 10px 0;
        }

        .website-item {
            padding: 15px 20px;
            color: white;
            cursor: pointer;
            transition: background-color 0.2s;
            border-left: 3px solid transparent;
            font-family: 'Arial', sans-serif;
            font-size: 14px;
        }

        .website-item:hover {
            background-color: rgba(255, 107, 53, 0.1);
            border-left-color: #ff6b35;
        }

        .website-item.active {
            background-color: rgba(255, 107, 53, 0.2);
            border-left-color: #ff6b35;
        }

        .website-item .name {
            font-weight: 600;
        }
        
        .content-wrapper {
            flex: 1;
            overflow: hidden;
            position: relative;
            transition: margin-left 0.3s ease;
        }

        .content-wrapper.shifted {
            margin-left: 250px;
        }

        .download-section {
            padding: 20px;
            background: #1a1a1a;
            color: white;
            height: 100%;
            overflow-y: auto;
            font-family: Arial, sans-serif;
        }

        .download-section h2 {
            margin: 0 0 20px 0;
            color: #ff6b35;
            font-size: 24px;
        }

        .download-actions {
            margin-bottom: 20px;
        }

        .download-actions button {
            padding: 10px 20px;
            background: #ff6b35;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }

        .download-actions button:hover {
            background: #ff8555;
        }

        .download-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .download-item {
            background: #2d2d2d;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #ff6b35;
        }

        .download-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .download-item-name {
            font-weight: 600;
            font-size: 16px;
            color: white;
        }

        .download-item-status {
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 12px;
        }

        .download-item-status.completed {
            background: #4caf50;
            color: white;
        }

        .download-item-status.downloading {
            background: #2196f3;
            color: white;
        }

        .download-item-status.failed {
            background: #f44336;
            color: white;
        }

        .download-item-info {
            font-size: 13px;
            color: #999;
            margin-bottom: 10px;
        }

        .download-item-actions {
            display: flex;
            gap: 10px;
        }

        .download-item-actions button {
            padding: 6px 12px;
            background: #444;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background 0.2s;
        }

        .download-item-actions button:hover {
            background: #555;
        }

        .download-item-actions button.delete {
            background: #f44336;
        }

        .download-item-actions button.delete:hover {
            background: #e53935;
        }

        .empty-message {
            text-align: center;
            color: #666;
            padding: 40px;
            font-size: 16px;
        }

        webview {
            display: inline-flex;
            width: 100%;
            height: 100%;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-family: Arial, sans-serif;
            font-size: 18px;
            z-index: 10;
        }

        /* ‰∏ãËΩΩËøõÂ∫¶ÊµÆÁ™ó */
        .download-popup {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 350px;
            max-height: 400px;
            background: #2d2d2d;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            z-index: 1000;
            overflow: hidden;
            display: none;
        }

        .download-popup.show {
            display: block;
        }

        .download-popup-header {
            padding: 15px;
            background: #1a1a1a;
            border-bottom: 2px solid #ff6b35;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .download-popup-header h3 {
            margin: 0;
            color: white;
            font-size: 16px;
        }

        .download-popup-close {
            background: transparent;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .download-popup-close:hover {
            background: rgba(255,255,255,0.1);
        }

        .download-popup-list {
            max-height: 320px;
            overflow-y: auto;
            padding: 10px;
        }

        .download-popup-item {
            background: #1a1a1a;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 8px;
            border-left: 3px solid #ff6b35;
        }

        .download-popup-item-name {
            color: white;
            font-size: 13px;
            margin-bottom: 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .download-progress-bar {
            width: 100%;
            height: 6px;
            background: #444;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 6px;
        }

        .download-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff6b35, #ff8555);
            transition: width 0.3s;
        }

        .download-popup-item-info {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: #999;
        }

        /* ‰∏ãËΩΩÈìæÊé•ËæìÂÖ•Ê®°ÊÄÅÊ°Ü */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1001;
            display: none;
        }

        .modal {
            width: 420px;
            max-width: 90%;
            background: #2d2d2d;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 16px;
            border: 2px solid #ff6b35;
        }

        .modal-header {
            color: #ff6b35;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .modal-body input {
            width: 100%;
            padding: 10px;
            border-radius: 6px;
            border: 1px solid #444;
            background: #1a1a1a;
            color: white;
            outline: none;
        }

        .modal-body input:focus {
            border-color: #ff6b35;
        }

        .modal-actions {
            margin-top: 12px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .modal-actions button {
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 13px;
            background: #ff6b35;
            color: white;
        }

        .modal-actions button.secondary {
            background: #444;
            color: white;
        }
    </style>
</head>
<body>
    <div class="titlebar">
        <button class="menu-button" id="menuToggle" title="ÂàáÊç¢ËèúÂçï">‚ò∞</button>
        <h1>È©∞Âì•Èü≥‰πê‰∏ãËΩΩÂô®</h1>
        <div class="window-controls">
            <button id="minimize" title="ÊúÄÂ∞èÂåñ">‚îÄ</button>
            <button id="maximize" title="ÊúÄÂ§ßÂåñ">‚ñ°</button>
            <button id="close" class="close" title="ÂÖ≥Èó≠">√ó</button>
        </div>
    </div>
    <div class="main-content">
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>üéµ ÁΩëÁ´ôÂØºËà™</h2>
            </div>
            <div class="website-list" id="websiteList">
                <!-- ÁΩëÁ´ôÂàóË°®Â∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
            </div>
            <div class="website-item" id="downloadsMenuItem" style="margin-top: 20px; border-top: 1px solid rgba(255, 107, 53, 0.3); padding-top: 20px;">
                <div class="name">üì• Â∑≤‰∏ãËΩΩ</div>
            </div>
        </div>
        <div class="content-wrapper">
            <div class="loading" id="loading">Âä†ËΩΩ‰∏≠...</div>
            <webview id="webview" src="https://y.wjhe.top/"
                     useragent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36"
                     webpreferences="contextIsolation=no">
            </webview>
            <div class="download-section" id="downloadSection" style="display: none;">
                <h2>üì• ‰∏ãËΩΩÁÆ°ÁêÜ</h2>
                <div class="download-actions">
                    <button id="openFolderBtn">ÊâìÂºÄ‰∏ãËΩΩÊñá‰ª∂Â§π</button>
                    <button id="testDownloadBtn" style="margin-left: 10px;">ÊµãËØï‰∏ãËΩΩ</button>
                    <button id="clearDownloadsBtn" style="margin-left: 10px; background: #f44336;">Ê∏ÖÁ©∫‰∏ãËΩΩËÆ∞ÂΩï</button>
                </div>
                <div class="download-list" id="downloadList">
                    <!-- ‰∏ãËΩΩÂàóË°®Â∞ÜÈÄöËøáJSÂä®ÊÄÅÁîüÊàê -->
                </div>
            </div>
        </div>
    <!-- ‰∏ãËΩΩËøõÂ∫¶ÊµÆÁ™ó -->
    <div class="download-popup" id="downloadPopup">
        <div class="download-popup-header">
            <h3>‚¨áÔ∏è ‰∏ãËΩΩ‰∏≠</h3>
            <button class="download-popup-close" id="closeDownloadPopup">√ó</button>
        </div>
        <div class="download-popup-list" id="downloadPopupList">
            <!-- Âä®ÊÄÅÁîüÊàê‰∏ãËΩΩÈ°π -->
        </div>
    </div>

    <!-- ËæìÂÖ•‰∏ãËΩΩURLÊ®°ÊÄÅÊ°Ü -->
    <div class="modal-overlay" id="downloadUrlModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">ËæìÂÖ•‰∏ãËΩΩÈìæÊé•</div>
            <div class="modal-body">
                <input id="downloadUrlInput" type="text" placeholder="ËØ∑ËæìÂÖ•Èü≥‰πêÊñá‰ª∂URLÔºàÊîØÊåÅ mp3„ÄÅflac Á≠âÔºâ">
            </div>
            <div class="modal-actions">
                <button id="confirmDownloadUrl">ÂºÄÂßã‰∏ãËΩΩ</button>
                <button class="secondary" id="cancelDownloadUrl">ÂèñÊ∂à</button>
            </div>
        </div>
    </div>

    </div>

    <script>
        const webview = document.getElementById('webview');
        const loading = document.getElementById('loading');
        const sidebar = document.getElementById('sidebar');
        const menuToggle = document.getElementById('menuToggle');
        const websiteList = document.getElementById('websiteList');

        // ÁΩëÁ´ôÂàóË°®ÈÖçÁΩÆ
        const websites = [
            {
                name: 'HE Music',
                url: 'https://y.wjhe.top/',
                icon: 'üéµ'
            },
            {
                name: 'Ê≠åÊõ≤ÂÆù',
                url: 'https://www.gequbao.com/',
                icon: 'üéº'
            },
            {
                name: 'Êó†ÊçüÈü≥‰πêÂêß',
                url: 'https://www.wsyyb.com/',
                icon: 'üíø'
            },
            {
                name: 'Èü≥‰πêÁ£ÅÂú∫',
                url: 'https://www.hifini.com/',
                icon: 'üéß'
            },
            {
                name: '5singÂéüÂàõÈü≥‰πê',
                url: 'https://5sing.kugou.com/',
                icon: 'üé§'
            },
            {
                name: 'ÊûúÊ†∏Èü≥‰πê',
                url: 'https://music.ghxi.com/',
                icon: 'üçé'
            }
        ];

        let currentWebsite = 0;
        let isDownloadView = false;
        const { ipcRenderer } = require('electron');

        // ‰∏ãËΩΩËØ∑Ê±ÇÂéªÈáçÔºàÁü≠Êó∂Èó¥ÂÜÖÁõ∏Âêå URL Âè™Ëß¶Âèë‰∏ÄÊ¨°Ôºâ
        const recentDownloadRequests = new Map();

        // ÁîüÊàêÁΩëÁ´ôÂàóË°®
        function renderWebsiteList() {
            websiteList.innerHTML = '';
            websites.forEach((site, index) => {
                const item = document.createElement('div');
                item.className = 'website-item' + (index === currentWebsite ? ' active' : '');
                item.innerHTML = `
                    <div class="name">${site.icon} ${site.name}</div>
                `;
                item.addEventListener('click', () => switchWebsite(index));
                websiteList.appendChild(item);
            });
        }

        // ÂàáÊç¢ÁΩëÁ´ô
        function switchWebsite(index) {
            if (isDownloadView) {
                showWebview();
            }
            currentWebsite = index;
            loading.style.display = 'block';
            loading.textContent = 'Âä†ËΩΩ‰∏≠...';
            loading.style.color = 'white';
            webview.src = websites[index].url;
            renderWebsiteList();
        }

        // ÊòæÁ§∫‰∏ãËΩΩÈ°µÈù¢
        async function showDownloads() {
            isDownloadView = true;
            webview.style.display = 'none';
            document.getElementById('downloadSection').style.display = 'block';
            loading.style.display = 'none';
            
            // Âä†ËΩΩ‰∏ãËΩΩÂéÜÂè≤
            const history = await ipcRenderer.invoke('get-download-history');
            renderDownloadList(history);
            
            // Êõ¥Êñ∞‰æßËæπÊ†èÈÄâ‰∏≠Áä∂ÊÄÅ
            document.querySelectorAll('.website-item').forEach(item => {
                item.classList.remove('active');
            });
            document.getElementById('downloadsMenuItem').classList.add('active');
        }

        // Ê∏≤Êüì‰∏ãËΩΩÂàóË°®
        function renderDownloadList(downloads) {
            const downloadList = document.getElementById('downloadList');
            
            if (downloads.length === 0) {
                downloadList.innerHTML = '<div class="empty-message">ÊöÇÊó†‰∏ãËΩΩËÆ∞ÂΩï</div>';
                return;
            }
            
            downloadList.innerHTML = downloads.map(item => {
                const date = new Date(item.startTime).toLocaleString('zh-CN');
                const size = item.size ? (item.size / 1024 / 1024).toFixed(2) + ' MB' : 'Êú™Áü•';
                const statusText = {
                    'completed': 'Â∑≤ÂÆåÊàê',
                    'downloading': '‰∏ãËΩΩ‰∏≠',
                    'failed': 'Â§±Ë¥•',
                    'interrupted': 'Â∑≤‰∏≠Êñ≠'
                }[item.status] || item.status;
                
                return `
                    <div class="download-item">
                        <div class="download-item-header">
                            <div class="download-item-name">${item.fileName}</div>
                            <div class="download-item-status ${item.status}">${statusText}</div>
                        </div>
                        <div class="download-item-info">
                            ‰∏ãËΩΩÊó∂Èó¥: ${date} | Êñá‰ª∂Â§ßÂ∞è: ${size}
                        </div>
                        <div class="download-item-actions">
                            ${item.status === 'completed' ? `
                                <button onclick="openFile('${item.filePath.replace(/\\/g, '\\\\')}')">ÊâìÂºÄÊñá‰ª∂</button>
                            ` : ''}
                            <button class="delete" onclick="deleteDownload('${item.id}')">Âà†Èô§ËÆ∞ÂΩï</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ÊâìÂºÄÊñá‰ª∂
        async function openFile(filePath) {
            await ipcRenderer.invoke('open-file', filePath);
        }

        // Âà†Èô§‰∏ãËΩΩËÆ∞ÂΩï
        async function deleteDownload(id) {
            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°‰∏ãËΩΩËÆ∞ÂΩïÂêó?')) {
                const newHistory = await ipcRenderer.invoke('delete-download', id);
                renderDownloadList(newHistory);
            }
        }

        // ËøîÂõûÁΩëÁ´ôÊµèËßàÊ®°Âºè
        function showWebview() {
            isDownloadView = false;
            webview.style.display = 'inline-flex';
            document.getElementById('downloadSection').style.display = 'none';
            document.getElementById('downloadsMenuItem').classList.remove('active');
            renderWebsiteList();
        }

        // ÂàáÊç¢‰æßËæπÊ†è
        const contentWrapper = document.querySelector('.content-wrapper');
        menuToggle.addEventListener('click', () => {
            sidebar.classList.toggle('active');
            contentWrapper.classList.toggle('shifted');
        });

        // ÁÇπÂáªÂÜÖÂÆπÂå∫ÂüüÂÖ≥Èó≠‰æßËæπÊ†è
        contentWrapper.addEventListener('click', (e) => {
            // Â¶ÇÊûúÁÇπÂáªÁöÑÊòØ‰∏ãËΩΩÂå∫Âüü,‰∏çÂÖ≥Èó≠‰æßËæπÊ†è
            if (e.target.closest('#downloadSection')) {
                return;
            }
            if (sidebar.classList.contains('active')) {
                sidebar.classList.remove('active');
                contentWrapper.classList.remove('shifted');
            }
        });

        // Â∑≤‰∏ãËΩΩËèúÂçïÈ°πÁÇπÂáª‰∫ã‰ª∂
        document.getElementById('downloadsMenuItem').addEventListener('click', () => {
            showDownloads();
            sidebar.classList.remove('active');
            contentWrapper.classList.remove('shifted');
        });

        // ÊâìÂºÄ‰∏ãËΩΩÊñá‰ª∂Â§πÊåâÈíÆ
        document.getElementById('openFolderBtn').addEventListener('click', async () => {
            await ipcRenderer.invoke('open-download-folder');
        });

        // ÊµãËØï‰∏ãËΩΩÊåâÈíÆÔºà‰ΩøÁî®Ëá™ÂÆö‰πâÊ®°ÊÄÅÊ°ÜÊõø‰ª£ promptÔºâ
        document.getElementById('testDownloadBtn').addEventListener('click', () => {
            showDownloadUrlModal();
        });
        
        // Ê∏ÖÁ©∫‰∏ãËΩΩËÆ∞ÂΩïÊåâÈíÆ
        document.getElementById('clearDownloadsBtn').addEventListener('click', async () => {
            if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâ‰∏ãËΩΩËÆ∞ÂΩïÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ')) {
                const empty = await ipcRenderer.invoke('clear-downloads');
                renderDownloadList(empty);
            }
        });

        // ÊòæÁ§∫‰∏ãËΩΩURLËæìÂÖ•Ê®°ÊÄÅÊ°Ü
        function showDownloadUrlModal() {
            const modal = document.getElementById('downloadUrlModal');
            const input = document.getElementById('downloadUrlInput');
            modal.style.display = 'block';
            input.value = '';
            input.focus();
        }

        // ÈöêËóè‰∏ãËΩΩURLËæìÂÖ•Ê®°ÊÄÅÊ°Ü
        function hideDownloadUrlModal() {
            const modal = document.getElementById('downloadUrlModal');
            modal.style.display = 'none';
        }

        // Ê†°È™åÈü≥È¢ëÈìæÊé•
        function isValidAudioUrl(url) {
            try {
                const u = new URL(url);
                return (/\.(mp3|flac|wav|m4a|aac|ogg|wma|ape|ncm)$/i.test(u.pathname) || /download|music|audio/i.test(url));
            } catch (e) {
                return false;
            }
        }

        // ÁªëÂÆöÊ®°ÊÄÅÊ°ÜÊåâÈíÆ‰∫ã‰ª∂
        document.getElementById('confirmDownloadUrl').addEventListener('click', async () => {
            const url = document.getElementById('downloadUrlInput').value.trim();
            if (!url || !isValidAudioUrl(url)) {
                alert('ËØ∑ËæìÂÖ•ÊúâÊïàÁöÑÈü≥‰πê‰∏ãËΩΩÈìæÊé•ÔºàÊîØÊåÅ mp3„ÄÅflac Á≠âÊ†ºÂºèÔºâ');
                return;
            }
            hideDownloadUrlModal();
            console.log('ÊâãÂä®‰∏ãËΩΩ:', url);
            await handleDownload(url);
        });

        document.getElementById('cancelDownloadUrl').addEventListener('click', () => {
            hideDownloadUrlModal();
        });

        // ËæìÂÖ•Ê°ÜÈîÆÁõò‰∫ã‰ª∂ÔºöEnter Á°ÆËÆ§ÔºåEsc ÂèñÊ∂à
        document.getElementById('downloadUrlInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('confirmDownloadUrl').click();
            } else if (e.key === 'Escape') {
                hideDownloadUrlModal();
            }
        });

        // ÁõëÂê¨Êù•Ëá™‰∏ªËøõÁ®ãÁöÑ‰∏ãËΩΩÈìæÊé•Ê∂àÊÅØ
        ipcRenderer.on('download-link', (event, url) => {
            console.log('Êî∂Âà∞Êù•Ëá™‰∏ªËøõÁ®ãÁöÑ‰∏ãËΩΩËØ∑Ê±Ç:', url);
            handleDownload(url);
        });

        // ‰∏ãËΩΩËøõÂ∫¶ÊµÆÁ™óÁÆ°ÁêÜ
        const downloadPopup = document.getElementById('downloadPopup');
        const downloadPopupList = document.getElementById('downloadPopupList');
        const closeDownloadPopup = document.getElementById('closeDownloadPopup');
        const activeDownloads = new Map();

        // ÂÖ≥Èó≠‰∏ãËΩΩÊµÆÁ™ó
        closeDownloadPopup.addEventListener('click', () => {
            downloadPopup.classList.remove('show');
        });

        // ÊòæÁ§∫‰∏ãËΩΩÊµÆÁ™ó
        function showDownloadPopup() {
            downloadPopup.classList.add('show');
        }

        // Êõ¥Êñ∞‰∏ãËΩΩÊµÆÁ™óÂàóË°®
        function updateDownloadPopup() {
            if (activeDownloads.size === 0) {
                downloadPopup.classList.remove('show');
                return;
            }

            downloadPopupList.innerHTML = Array.from(activeDownloads.values()).map(item => {
                const progress = item.progress || 0;
                const speed = item.speed || '0 KB/s';
                const status = item.status === 'completed' ? '‚úì Â∑≤ÂÆåÊàê' : '‰∏ãËΩΩ‰∏≠...';
                
                return `
                    <div class="download-popup-item">
                        <div class="download-popup-item-name">${item.fileName}</div>
                        <div class="download-progress-bar">
                            <div class="download-progress-fill" style="width: ${progress}%"></div>
                        </div>
                        <div class="download-popup-item-info">
                            <span>${status}</span>
                            <span>${progress.toFixed(1)}%</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ÁõëÂê¨‰∏ãËΩΩÂºÄÂßã
        ipcRenderer.on('download-started', (event, item) => {
            console.log('‰∏ãËΩΩÂºÄÂßã:', item.fileName);
            activeDownloads.set(item.id, {
                ...item,
                progress: 0,
                speed: '0 KB/s'
            });
            showDownloadPopup();
            updateDownloadPopup();
        });

        // ÁõëÂê¨‰∏ãËΩΩËøõÂ∫¶
        ipcRenderer.on('download-progress', (event, data) => {
            const item = activeDownloads.get(data.id);
            if (item) {
                item.progress = parseFloat(data.progress) || 0;
                item.status = data.status;
                updateDownloadPopup();
            }
        });

        // ÁõëÂê¨‰∏ãËΩΩÂÆåÊàê
        ipcRenderer.on('download-completed', (event, item) => {
            console.log('‰∏ãËΩΩÂÆåÊàê:', item.fileName);
            const downloadItem = activeDownloads.get(item.id);
            if (downloadItem) {
                downloadItem.status = 'completed';
                downloadItem.progress = 100;
                updateDownloadPopup();
                
                // 3ÁßíÂêéÁßªÈô§Â∑≤ÂÆåÊàêÁöÑ‰∏ãËΩΩ
                setTimeout(() => {
                    activeDownloads.delete(item.id);
                    updateDownloadPopup();
                }, 3000);
            }
            
            // Â¶ÇÊûúÂΩìÂâçÂú®‰∏ãËΩΩÈ°µÈù¢,Âà∑Êñ∞ÂàóË°®
            if (isDownloadView) {
                showDownloads();
            }
        });

        // ÁõëÂê¨‰∏ãËΩΩÂ§±Ë¥•
        ipcRenderer.on('download-failed', (event, item) => {
            console.log('‰∏ãËΩΩÂ§±Ë¥•:', item.fileName);
            activeDownloads.delete(item.id);
            updateDownloadPopup();
        });

        // Â§ÑÁêÜ‰∏ãËΩΩÔºàÊîØÊåÅÂèØÈÄâÁöÑÂêçÁß∞ÁåúÊµãÔºâ
        async function handleDownload(url, nameGuess = '') {
            console.log('ÂºÄÂßãÂ§ÑÁêÜ‰∏ãËΩΩ:', url, 'ÂêçÁß∞ÁåúÊµã:', nameGuess);
            try {
                await ipcRenderer.invoke('download-file', url, nameGuess);
            } catch (error) {
                console.error('‰∏ãËΩΩÂ§±Ë¥•:', error);
                alert('‰∏ãËΩΩÂ§±Ë¥•: ' + error.message);
            }
        }

        // Âú®webviewÂä†ËΩΩÂÆåÊàêÂêéÊ≥®ÂÖ•Â¢ûÂº∫ÁöÑ‰∏ãËΩΩÊã¶Êà™‰ª£Á†Å
        webview.addEventListener('did-finish-load', () => {
            loading.style.display = 'none';
            
            // Ê≥®ÂÖ•‰ª£Á†ÅÊã¶Êà™‰∏ãËΩΩÈìæÊé•
            const injectCode = `
                (function() {
                    console.log('‰∏ãËΩΩÊã¶Êà™ËÑöÊú¨Â∑≤Âä†ËΩΩ');
                    
                    // ‰ªÖËØÜÂà´Èü≥È¢ëÁõ¥Èìæ
                    const audioRegex = /\\.(mp3|flac|wav|m4a|aac|ogg|wma|ape|ncm)(\\?.*)?$/i;
                    
                    // Áªü‰∏ÄËß¶Âèë‰∏ªËøõÁ®ã‰∏ãËΩΩÁöÑÊñπÊ≥ï
                    function requestDownload(url, nameGuess = '') {
                        try {
                            if (nameGuess) {
                                nameGuess = String(nameGuess).replace(/[\\/:*?"<>|]/g, '_').trim();
                            }
                            const oldTitle = document.title;
                            document.title = 'DOWNLOAD_REQUEST:' + encodeURIComponent(url) + '::' + encodeURIComponent(nameGuess || '');
                            setTimeout(() => {
                                document.title = oldTitle;
                            }, 100);
                        } catch (e) {
                            console.warn('Ëß¶Âèë‰∏ãËΩΩÂ§±Ë¥•:', e);
                        }
                    }
                    
                    // ÁõëÂê¨ÊâÄÊúâÁÇπÂáª‰∫ã‰ª∂ÔºàA Ê†áÁ≠æÔºâ
                    document.addEventListener('click', function(e) {
                        // Êü•ÊâæÊúÄËøëÁöÑaÊ†áÁ≠æ
                        let target = e.target;
                        while (target && target.tagName !== 'A') {
                            target = target.parentElement;
                            if (!target || target === document.body) break;
                        }
                        
                        if (target && target.tagName === 'A' && target.href) {
                            const url = target.href;
                            console.log('ÁÇπÂáªÈìæÊé•:', url);
                            
                            // Ê£ÄÊµãÈü≥È¢ëÊñá‰ª∂Êàñ‰∏ãËΩΩÈìæÊé•
                            const isAudioFile = /\\.(mp3|flac|wav|m4a|aac|ogg|wma|ape|ncm)/i.test(url);
                            const hasDownload = target.hasAttribute('download');
                            const isDownloadUrl = /download|music|audio/i.test(url);
                            
                            if (isAudioFile || hasDownload || isDownloadUrl) {
                                console.log('Ê£ÄÊµãÂà∞‰∏ãËΩΩÈìæÊé•ÔºåÂáÜÂ§áÊã¶Êà™');
                                e.preventDefault();
                                e.stopPropagation();
                                e.stopImmediatePropagation();
                                
                                // ÂêçÁß∞ÁåúÊµã
                                const nameGuessAttr = target.getAttribute('download') || target.getAttribute('title') || '';
                                const linkText = (target.textContent || '').trim();
                                let nameGuess = nameGuessAttr || linkText;
                                try {
                                    const u = new URL(url);
                                    const fnParam = u.searchParams.get('filename') || u.searchParams.get('name') || '';
                                    if (!nameGuess && fnParam) nameGuess = fnParam;
                                } catch (e) {}
                                
                                requestDownload(url, nameGuess || '');
                                return false;
                            }
                        }
                    }, true);
                    
                    // Èí©‰Ωè XMLHttpRequestÔºåÊã¶Êà™Èü≥È¢ëÁõ¥ÈìæÔºàÁ´ôÁÇπÁî® XHR/fetch ÂèëËµ∑‰∏ãËΩΩÊó∂Ôºâ
                    try {
                        const origOpen = XMLHttpRequest.prototype.open;
                        const origSend = XMLHttpRequest.prototype.send;
                        XMLHttpRequest.prototype.open = function(method, url) {
                            try { this.__he_url = url; } catch (_) {}
                            return origOpen.apply(this, arguments);
                        };
                        XMLHttpRequest.prototype.send = function(body) {
                            try {
                                const url = this.__he_url || '';
                                if (audioRegex.test(url)) {
                                    console.log('XHR Êã¶Êà™Èü≥È¢ëÁõ¥Èìæ:', url);
                                    requestDownload(url, '');
                                    try { this.abort(); } catch (_) {}
                                    return; // ÈòªÊ≠¢ÂÆûÈôÖËØ∑Ê±ÇÔºåÈÅøÂÖç CORS Êä•Èîô
                                }
                            } catch (_) {}
                            return origSend.apply(this, arguments);
                        };
                    } catch (e) {
                        console.warn('XMLHttpRequest Êã¶Êà™Â§±Ë¥•:', e);
                    }
                    
                    // Èí©‰Ωè fetchÔºåÊã¶Êà™Èü≥È¢ëÁõ¥Èìæ
                    try {
                        const origFetch = window.fetch;
                        window.fetch = function(input, init) {
                            try {
                                const url = typeof input === 'string' ? input : (input && input.url) || '';
                                if (audioRegex.test(url)) {
                                    console.log('fetch Êã¶Êà™Èü≥È¢ëÁõ¥Èìæ:', url);
                                    requestDownload(url, '');
                                    return Promise.reject(new Error('intercepted audio fetch for download'));
                                }
                            } catch (_) {}
                            return origFetch.apply(this, arguments);
                        };
                    } catch (e) {
                        console.warn('fetch Êã¶Êà™Â§±Ë¥•:', e);
                    }
                    
                    console.log('‰∏ãËΩΩÊã¶Êà™Â∑≤ÊøÄÊ¥ª');
                })();
            `;
            
            webview.executeJavaScript(injectCode).then(() => {
                console.log('Ê≥®ÂÖ•ËÑöÊú¨ÊàêÂäü');
            }).catch(err => {
                console.error('Ê≥®ÂÖ•‰∏ãËΩΩÊã¶Êà™‰ª£Á†ÅÂ§±Ë¥•:', err);
            });
        });

        // ÁõëÂê¨consoleÊ∂àÊÅØÊù•Ëé∑Âèñ‰∏ãËΩΩËØ∑Ê±Ç
        webview.addEventListener('console-message', (e) => {
            console.log('Webview:', e.message);
            
            if (e.message.includes('Ê£ÄÊµãÂà∞‰∏ãËΩΩÈìæÊé•')) {
                console.log('ÂáÜÂ§áÊã¶Êà™‰∏ãËΩΩ');
            }
        });

        // ÁõëÂê¨È°µÈù¢Ê†áÈ¢òÂèòÂåñÊù•Êé•Êî∂‰∏ãËΩΩËØ∑Ê±ÇÔºàÂ∏¶ÂéªÈáçÔºâ
        webview.addEventListener('page-title-updated', (e) => {
            const title = e.title;
            if (title && title.startsWith('DOWNLOAD_REQUEST:')) {
                const payload = title.replace('DOWNLOAD_REQUEST:', '');
                let url = payload;
                let nameGuess = '';
                if (payload.includes('::')) {
                    const parts = payload.split('::');
                    const u = parts[0] || '';
                    const n = parts[1] || '';
                    try { url = decodeURIComponent(u); } catch (_) { url = u; }
                    try { nameGuess = decodeURIComponent(n); } catch (_) { nameGuess = n; }
                } else {
                    try { url = decodeURIComponent(payload); } catch (_) { url = payload; }
                }
                // Ê∏≤ÊüìÁ´ØÁü≠Êó∂ÂéªÈáçÔºö3 ÁßíÂÜÖÁõ∏Âêå URL Âè™Ëß¶Âèë‰∏ÄÊ¨°ÔºåÈÅøÂÖçÁÇπÂáª‰∏é XHR/fetch ÂèåÈáçËß¶Âèë
                try {
                    const key = String(url || '').toLowerCase();
                    const now = Date.now();
                    const last = recentDownloadRequests.get(key) || 0;
                    if (now - last < 3000) {
                        console.log('ÂøΩÁï•ÈáçÂ§ç DOWNLOAD_REQUESTÔºà3s ÂÜÖÔºâÔºö', url);
                        return;
                    }
                    recentDownloadRequests.set(key, now);
                    // Âª∂ËøüÊ∏ÖÁêÜÔºåÈÅøÂÖç Map ËÜ®ËÉÄ
                    setTimeout(() => {
                        const t = recentDownloadRequests.get(key) || 0;
                        if (Date.now() - t >= 3000) {
                            recentDownloadRequests.delete(key);
                        }
                    }, 5000);
                } catch (_) {}
                console.log('Êé•Êî∂Âà∞‰∏ãËΩΩËØ∑Ê±Ç:', url, 'ÂêçÁß∞ÁåúÊµã:', nameGuess);
                handleDownload(url, nameGuess);
            }
        });
        // ÂàùÂßãÂåñÁΩëÁ´ôÂàóË°®
        renderWebsiteList();

        // Â§ÑÁêÜÂä†ËΩΩÂ§±Ë¥•
        webview.addEventListener('did-fail-load', (event) => {
            if (event.errorCode !== -3) { // -3 ÊòØÂèñÊ∂àÂä†ËΩΩÔºåÂèØ‰ª•ÂøΩÁï•
                loading.textContent = 'Âä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúËøûÊé•';
                loading.style.color = '#ff6b6b';
            }
        });

        // Êñ∞Á™óÂè£Âú®Â§ñÈÉ®ÊµèËßàÂô®ÊâìÂºÄ
        webview.addEventListener('new-window', (e) => {
            require('electron').shell.openExternal(e.url);
        });

        // Á™óÂè£ÊéßÂà∂ÊåâÈíÆ
        document.getElementById('minimize').addEventListener('click', () => {
            ipcRenderer.send('window-minimize');
        });

        document.getElementById('maximize').addEventListener('click', () => {
            ipcRenderer.send('window-maximize');
        });

        document.getElementById('close').addEventListener('click', () => {
            ipcRenderer.send('window-close');
        });
    </script>
</body>
</html>